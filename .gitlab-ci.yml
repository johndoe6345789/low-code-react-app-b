stages:
  - lint
  - test
  - build
  - security
  - docker
  - deploy

variables:
  NODE_VERSION: '20'
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: '/certs'
  NPM_CONFIG_CACHE: '$CI_PROJECT_DIR/.npm'
  REGISTRY: '$CI_REGISTRY_IMAGE'

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/

.node_template: &node_template
  image: node:${NODE_VERSION}-alpine
  before_script:
    - node --version
    - npm --version
    - npm ci --cache .npm --prefer-offline

lint:eslint:
  <<: *node_template
  stage: lint
  script:
    - npm run lint || echo "No lint script found"
  allow_failure: false

lint:typecheck:
  <<: *node_template
  stage: lint
  script:
    - npx tsc --noEmit
  allow_failure: false

test:unit:
  <<: *node_template
  stage: test
  script:
    - npm test || echo "No test script found"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week

build:app:
  <<: *node_template
  stage: build
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  needs:
    - lint:eslint
    - lint:typecheck
    - test:unit

test:e2e:
  image: mcr.microsoft.com/playwright:v1.42.0-focal
  stage: test
  script:
    - npm ci --cache .npm --prefer-offline
    - npx playwright install chromium
    - npm run test:e2e || echo "No E2E tests configured"
  artifacts:
    when: always
    paths:
      - playwright-report/
    expire_in: 1 week
  needs:
    - build:app
  allow_failure: true

security:audit:
  <<: *node_template
  stage: security
  script:
    - npm audit --audit-level=moderate || true
  allow_failure: true

security:trivy:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: ['']
  script:
    - trivy fs --exit-code 0 --no-progress --format json --output trivy-report.json .
    - trivy fs --exit-code 1 --severity CRITICAL --no-progress .
  artifacts:
    reports:
      container_scanning: trivy-report.json
  allow_failure: true

docker:build:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $REGISTRY:$CI_COMMIT_REF_SLUG -t $REGISTRY:$CI_COMMIT_SHORT_SHA .
    - docker push $REGISTRY:$CI_COMMIT_REF_SLUG
    - docker push $REGISTRY:$CI_COMMIT_SHORT_SHA
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag $REGISTRY:$CI_COMMIT_SHORT_SHA $REGISTRY:latest
        docker push $REGISTRY:latest
      fi
  needs:
    - build:app
    - test:unit
    - security:audit
  only:
    - main
    - develop
    - tags

deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to staging environment..."
    - echo "Image: $REGISTRY:develop-$CI_COMMIT_SHORT_SHA"
    - |
      curl -X POST $STAGING_WEBHOOK_URL \
        -H "Content-Type: application/json" \
        -d "{\"image\":\"$REGISTRY:develop\",\"sha\":\"$CI_COMMIT_SHORT_SHA\"}"
  environment:
    name: staging
    url: https://staging.codeforge.example.com
  needs:
    - docker:build
  only:
    - develop

deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to production environment..."
    - echo "Image: $REGISTRY:main-$CI_COMMIT_SHORT_SHA"
    - |
      curl -X POST $PRODUCTION_WEBHOOK_URL \
        -H "Content-Type: application/json" \
        -d "{\"image\":\"$REGISTRY:latest\",\"sha\":\"$CI_COMMIT_SHORT_SHA\"}"
  environment:
    name: production
    url: https://codeforge.example.com
  needs:
    - docker:build
    - test:e2e
  when: manual
  only:
    - main
